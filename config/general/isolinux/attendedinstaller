#!/bin/bash
# Copyright (c) Microsoft Corporation.
# Licensed under the MIT License.

ISO_ROOT=/cdrom
CONFIG_ROOT=$ISO_ROOT/config

# Mounting the ISO root for the installer.
mkdir -p $ISO_ROOT
LABEL=OIC_CDROM

function retry {
    local retry=0
    local limit=10
    local sleep_seconds=15
    while [ $retry -lt $limit ]
    do
        eval "$@" && break
        echo "$@" Retrying...
        ((retry++))
        sleep $sleep_seconds
    done
}

if grep -qs $ISO_ROOT /proc/mounts; then
    echo ISO root already mounted
else
    echo Attempt to mount the ISO root
   # It is possible that the partition isn't ready to be mounted when this script
    # is first run. So use a retry loop. There is a race condition here where the
    # partition could be mounted between the first grep and the mount. If this happens
    # the mount will fail and the retry loop would retry the mount repeatedly. This
    # is handled by the 'or' in the retry loop which will grep for the mount point and
    # break out of the loop if it is found.
    retry "{ mount -L $LABEL -o ro $ISO_ROOT 2>/dev/null || grep -qs $ISO_ROOT /proc/mounts ; }"
fi

# Wait for X session to be ready
echo "Waiting for X session..."
timeout=300
count=0
while [ $count -lt $timeout ]; do
    if xset q &>/dev/null; then
        echo "X session is ready"
        break
    fi
    sleep 1
    count=$((count + 1))
done

if [ $count -ge $timeout ]; then
    echo "Warning: X session not ready after ${timeout}s, attempting to launch anyway"
fi

# Launch Madani OS GUI installer with logging
/usr/local/bin/installer-launcher.sh

# Drop to shell after installer exits
/bin/bash