name: Earthly Tests (coverage gate)

on:
  pull_request:
    branches: [ main ]          # Gate PRs into main
  push:
    branches: [ main ]          # (Optional) also run on direct pushes
  workflow_dispatch:             # Manual runs
    inputs:
      ref:
        description: "Branch or SHA to test (e.g. feature/x or a1b2c3)"
        required: false
      cov_threshold:
        description: "Override threshold (percent) for this manual run only"
        required: false

concurrency:
  group: earthly-tests-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  run-earthly-tests:
    name: Run earthly +test (coverage gate)
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          # Use input ref if provided; else PR head SHA; else current SHA
          ref: ${{ inputs.ref != '' && inputs.ref || (github.event_name == 'pull_request' && github.event.pull_request.head.sha || github.sha) }}

      - name: Setup Earthly
        uses: earthly/actions/setup-earthly@v1
        with:
          version: "latest"

      - name: Show Earthly version
        run: earthly --version

      - name: Resolve coverage threshold from file (and prevent lowering)
        id: threshold
        env:
          MANUAL_COV: ${{ inputs.cov_threshold }}
          EVENT_NAME: ${{ github.event_name }}
          BASE_REF: ${{ github.event.pull_request.base.ref }}
        run: |
          set -euo pipefail
          FILE=".github/coverage-threshold.txt"
          DEFAULT="70"

          parse_num() {
            # extract first number like 75 or 82.5 from stdin
            grep -Eo '^[[:space:]]*[0-9]+([.][0-9]+)?' | tr -d ' ' | head -n1 || true
          }

          if [[ -n "${MANUAL_COV:-}" ]]; then
            HEAD_VAL="${MANUAL_COV}"
          else
            if [[ -f "$FILE" ]]; then
              HEAD_VAL="$(parse_num < "$FILE")"
            fi
          fi

          if [[ -z "${HEAD_VAL:-}" ]]; then
            HEAD_VAL="$DEFAULT"
          fi

          # If this is a PR, compare against main's value and forbid lowering
          if [[ "${EVENT_NAME}" == "pull_request" ]]; then
            git fetch --no-tags --depth=1 origin "${BASE_REF}"
            if git cat-file -e "origin/${BASE_REF}:${FILE}" 2>/dev/null; then
              BASE_VAL="$(git show "origin/${BASE_REF}:${FILE}" | parse_num)"
              if [[ -n "${BASE_VAL}" ]]; then
                awk -v head="$HEAD_VAL" -v base="$BASE_VAL" 'BEGIN{
                  # fail if head < base
                  if ((head+0) < (base+0)) { exit 1 } else { exit 0 }
                }' || {
                  echo "::error::Threshold cannot be lowered in PR. Base=${BASE_VAL}, Proposed=${HEAD_VAL}"
                  exit 1
                }
              fi
            fi
          fi

          echo "COV_THRESHOLD=${HEAD_VAL}" >> "$GITHUB_ENV"
          echo "PRINT_TS=${GITHUB_RUN_ID}" >> "$GITHUB_ENV"

          echo "Resolved threshold: ${HEAD_VAL}"

      # Key: do NOT use --ci since your Earthfile uses LOCALLY/AS LOCAL
      - name: Run Earthly +test with coverage threshold
        run: |
          earthly +test --COV_THRESHOLD="${COV_THRESHOLD}" --PRINT_TS="${PRINT_TS}"

      # Always upload artifacts saved by Earthfile
      - name: Upload coverage.out
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage.out
          path: coverage.out

      - name: Upload coverage_total.txt
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage_total.txt
          path: coverage_total.txt

      - name: Upload coverage_packages.txt
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage_packages.txt
          path: coverage_packages.txt

      - name: Upload test_raw.log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test_raw.log
          path: test_raw.log

      - name: Publish coverage summary
        if: always()
        run: |
          {
            echo "## Coverage Summary"
            if [[ -f coverage_total.txt ]]; then
              echo ""
              echo '```'
              cat coverage_total.txt
              echo '```'
            fi
            if [[ -f coverage_packages.txt ]]; then
              echo ""
              echo "Packages by coverage (lowest first):"
              echo '```'
              head -n 20 coverage_packages.txt || true
              echo '```'
            fi
            echo ""
            echo "**Threshold used:** ${COV_THRESHOLD}%"
          } >> "$GITHUB_STEP_SUMMARY"

