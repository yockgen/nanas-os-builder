{
    "$schema": "https://json-schema.org/draft/2020-12/schema",
    "$id": "os-image-template.schema.json",
    "title": "OS Image Template",
    "description": "Defines image configuration including target OS, packages, kernel, and system configurations",
    "type": "object",
    "properties": {
        "image": {
            "type": "object",
            "description": "Image metadata and versioning",
            "properties": {
                "name": {
                    "type": "string",
                    "description": "Name of the image template",
                    "pattern": "^[a-zA-Z0-9]([a-zA-Z0-9\\-_]*[a-zA-Z0-9])?$"
                },
                "version": {
                    "type": "string",
                    "description": "Version of the image template",
                    "pattern": "^[0-9]+(\\.([0-9]+|[0-9]*[a-zA-Z-][0-9a-zA-Z-]*)){0,2}(\\+[0-9a-zA-Z-]+(\\.[0-9a-zA-Z-]+)*)?$"
                }
            },
            "required": ["name", "version"],
            "additionalProperties": false
        },
        "target": {
            "type": "object",
            "description": "Target platform and system configuration",
            "properties": {
                "os": {
                    "type": "string",
                    "description": "Target operating system",
                    "enum": ["azure-linux", "edge-microvisor-toolkit", "wind-river-elxr"]
                },
                "dist": {
                    "type": "string",
                    "description": "Target distribution version"
                },
                "arch": {
                    "type": "string",
                    "description": "Target architecture",
                    "enum": ["x86_64", "aarch64", "armv7hl"]
                },
                "imageType": {
                    "type": "string",
                    "description": "Type of image to build",
                    "enum": ["raw", "iso", "qcow2", "vhd", "vhdx", "vmdk"]
                }
            },
            "required": ["os", "dist", "arch", "imageType"],
            "additionalProperties": false,
            "allOf": [
                {
                    "if": {
                        "properties": { "os": { "const": "azure-linux" } }
                    },
                    "then": {
                        "properties": {
                            "dist": { "enum": ["azl3"] }
                        }
                    }
                },
                {
                    "if": {
                        "properties": { "os": { "const": "edge-microvisor-toolkit" } }
                    },
                    "then": {
                        "properties": {
                            "dist": { "enum": ["emt3"] }
                        }
                    }
                },
                {
                    "if": {
                        "properties": { "os": { "const": "wind-river-elxr" } }
                    },
                    "then": {
                        "properties": {
                            "dist": { "enum": ["elxr12", "elxr23"] }
                        }
                    }
                }
            ]
        },
        "disk": {
            "type": "object",
            "description": "Disk configuration (optional, uses defaults if omitted)",
            "properties": {
                "name": {
                    "type": "string",
                    "description": "Name of the disk configuration"
                },
                "artifacts": {
                    "type": "array",
                    "description": "Output artifacts configuration",
                    "items": {
                        "type": "object",
                        "properties": {
                            "type": {
                                "type": "string",
                                "description": "Output format type",
                                "enum": ["raw", "qcow2", "vhd", "vhdx", "vmdk"]
                            },
                            "compression": {
                                "type": "string",
                                "description": "Compression format (optional)",
                                "enum": ["gz", "gzip", "xz", "zstd", "bz2"]
                            }
                        },
                        "required": ["type"],
                        "additionalProperties": false
                    }
                },
                "size": {
                    "type": "string",
                    "description": "Size of the disk (e.g., '4GiB', '8GB')"
                },
                "partitionTableType": {
                    "type": "string",
                    "description": "Partition table type",
                    "enum": ["gpt", "mbr"]
                },
                "partitions": {
                    "type": "array",
                    "description": "Partition layout",
                    "items": {
                        "type": "object",
                        "properties": {
                            "id": {
                                "type": "string",
                                "description": "Partition identifier"
                            },
                            "name": {
                                "type": "string",
                                "description": "Partition name/label"
                            },
                            "type": {
                                "type": "string",
                                "description": "Partition type"
                            },
                            "fsType": {
                                "type": "string",
                                "description": "Filesystem type"
                            },
                            "start": {
                                "type": "string",
                                "description": "Partition start offset"
                            },
                            "end": {
                                "type": "string",
                                "description": "Partition end offset (0 = rest of disk)"
                            },
                            "mountPoint": {
                                "type": "string",
                                "description": "Mount point path"
                            },
                            "mountOptions": {
                                "type": "string",
                                "description": "Mount options"
                            },
                            "flags": {
                                "type": "array",
                                "description": "Partition flags",
                                "items": {
                                    "type": "string"
                                }
                            }
                        },
                        "additionalProperties": false
                    }
                }
            },
            "additionalProperties": false
        },
        "systemConfig": {
            "type": "object",
            "description": "System configuration object",
            "properties": {
                "name": {
                    "type": "string",
                    "description": "Name of the system configuration"
                },
                "description": {
                    "type": "string",
                    "description": "Description of the system configuration"
                },
                "immutability": {
                    "type": "object",
                    "description": "Immutability configuration (optional)",
                    "additionalProperties": true
                },
                "users": {
                    "type": "array",
                    "description": "User configurations (optional)",
                    "items": {
                        "type": "object",
                        "properties": {
                            "name": {
                                "type": "string",
                                "description": "Username for the user account"
                            },
                            "password": {
                                "type": "string",
                                "description": "Plain text password (discouraged for security)"
                            },
                            "hash_algo": {
                                "type": "string",
                                "description": "Algorithm to hash the password (e.g., 'sha512', 'bcrypt')"
                            },
                            "passwordMaxAge": {
                                "type": "integer",
                                "description": "Maximum password age in days"
                            },
                            "startupScript": {
                                "type": "string",
                                "description": "Shell/script to run on login"
                            },
                            "groups": {
                                "type": "array",
                                "description": "Additional groups to add user to",
                                "items": {
                                    "type": "string"
                                }
                            },
                            "sudo": {
                                "type": "boolean",
                                "description": "Whether to grant sudo permissions"
                            },
                            "home": {
                                "type": "string",
                                "description": "Custom home directory path"
                            },
                            "shell": {
                                "type": "string",
                                "description": "Login shell (e.g., /bin/bash, /bin/zsh)"
                            }
                        },
                        "required": ["name"],
                        "additionalProperties": false
                    }
                },
                "bootloader": {
                    "type": "object",
                    "description": "Bootloader configuration",
                    "properties": {
                        "bootType": {
                            "type": "string",
                            "description": "Boot type",
                            "enum": ["efi", "legacy"]
                        },
                        "provider": {
                            "type": "string",
                            "description": "Bootloader provider",
                            "enum": ["grub", "grub2", "systemd-boot"]
                        }
                    },
                    "additionalProperties": false
                },
                "packages": {
                    "type": "array",
                    "description": "List of packages to include in the system",
                    "items": {
                        "type": "string",
                        "pattern": "^[a-zA-Z0-9]([a-zA-Z0-9\\-_.+]*[a-zA-Z0-9])?$"
                    },
                    "uniqueItems": true
                },
                "additionalFiles": {
                    "type": "array",
                    "description": "Additional files to include in the system",
                    "items": {
                        "type": "object",
                        "additionalProperties": true
                    }
                },
                "kernel": {
                    "type": "object",
                    "description": "Kernel configuration",
                    "properties": {
                        "version": {
                            "type": "string",
                            "description": "Kernel version"
                        },
                        "cmdline": {
                            "type": "string",
                            "description": "Kernel command line parameters"
                        }
                    },
                    "required": ["version"],
                    "additionalProperties": false
                }
            },
            "additionalProperties": false
        }
    },
    "required": ["image", "target"],
    "additionalProperties": false
}